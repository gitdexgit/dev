#---- This is important for nvim working well and for ghostty working well with ssh
set-option -g default-terminal "tmux-256color"

# set-option -ga terminal-features ",*256color*:RGB"

# This should be handled by tmux-yank plugin so this is redendent
# set -s set-clipboard on

set-option -s escape-time 0
set -g status-style 'bg=#333333 fg=#5eacd3'
# Set the right side of the status bar to be empty
set-option -g status-right ""



set-window-option -g mode-keys vi
bind S run-shell tmux-ready

# isn't this redendent?
# Enable True Color (RGB) support for capable terminals
# set-option -ga terminal-features ",*256color*:RGB"
# set-option -ga terminal-features ",alacritty:RGB"


# this is htop because btop needs good resize and yeah
# bind-key M-h run-shell "tmux neww tmux-sessionizer -s 0"

# [solid]this is lazygit. But, i don't use it as much. Gotta get good at lazygit and git.
# bind-key -n M-l run-shell "tmux neww tmux-sessionizer -s 1"

# [Question] This is nvim opened in ~/ idk why man... what's even the point of this ?
bind-key -n M-n run-shell "tmux neww tmux-sessionizer -s 2"

# [potential removal] this is matrix I don't care about this bs
bind-key -n M-b run-shell "tmux neww tmux-sessionizer -s 3"

# [Questoin] This is btop What's even the point of this ? when you have it in _a_ like what ?
bind-key -n M-y run-shell "tmux neww tmux-sessionizer -s 4"




#========== window management (tabs)

bind-key -n M-1 select-window -t :1
bind-key -n M-2 select-window -t :2
bind-key -n M-3 select-window -t :3
bind-key -n M-4 select-window -t :4
bind-key -n M-5 select-window -t :5
bind-key -n M-6 select-window -t :6
bind-key -n M-7 select-window -t :7
bind-key -n M-8 select-window -t :8
bind-key -n M-9 select-window -t :9
bind-key -n M-0 select-window -t :10





#========== pane management
bind-key w display-panes


TMUXCLIP_PATH="~/.local/bin/Tmuxclip"

# Adjust this path as necessary
# --- [0] CORE SETTINGS ---
# --- CORE SETTINGS or POPUP SECTION ---
# Remap prefix from 'C-b' to 'C-a'
unbind C-b

set-option -g prefix C-s

bind-key C-s send-prefix # Allows sending a literal C-a to applications

# Set a higher history limit
set-option -g history-limit 10000

# Allow repeating commands without re-typing the prefix (e.g., C-a > >)
set-option -g repeat-time 500

# Start window and pane numbering at 1
set -g base-index 1

setw -g pane-base-index 1

# Renumber windows automatically to prevent gaps
set -g renumber-windows on

# Enable full mouse support
set -g mouse on

# Allow Tmux to use the OSC 52 escape sequences for copy/paste
set -g allow-passthrough on

# If you are still having issues, explicitly bind the copy/paste operations to OSC 52
# (These lines are sometimes only necessary if you use Tmux's copy mode, but they help.)
set -w -g automatic-rename on

# Greatly improve responsiveness for editors like Vim



# --- [2] NAVIGATION (THE VIM WAY) ---
bind -r a last-window
bind -r h previous-window
bind -r l next-window



is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Use bind-key -r, which requires the prefix but is safe for all terminals.
bind-key -r 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -r 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -r 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -r 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R' # <-- Typo fixed here

# These bindings for copy mode are fine as they are.
bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# --- [1] KEY BINDINGS ---
bind r source-file ~/.tmux.conf \; display-message "~/.tmux.conf reloaded"

bind ` switch-client -t'{marked}'

## do not do C-a that will screw up tmux's C-a sadly with this you have to hit C-a twice
bind-key -r M-a switch-client -l
bind M-j choose-window 'join-pane -h -s "%%"'
bind J choose-window 'join-pane -s "%%"'

# --- [3] PANE MANAGEMENT ---
bind | split-window -hc "#{pane_current_path}"
bind - split-window -vc "#{pane_current_path}"
bind \\ split-window -hc "#{pane_current_path}"
bind _ split-window -vc "#{pane_current_path}"
bind -r x kill-pane
bind -r b break-pane

# Fuzzy find sessions to switch to
bind C-c send-keys 'C-l'

# ---- Popups ------------
bind g display-popup -w 80% -h 80% "lazygit"

bind e display-popup -w 80% -h 80% "yazi"
    
# Shows only the tmux sessions I have
bind C-t display-popup -h 80% -E "tmux list-sessions | sed 's/:.*//' | fzf --reverse | xargs tmux switch-client -t"

bind '!' display-popup -w 80% -h 80% "htop"
bind C-b display-popup -w 95% -h 95% "btop"

# Fuzzy find windows in the current session
bind s display-popup -E "tmux list-windows -F '#I:#W' | fzf --reverse | sed 's/:.*//' | xargs tmux select-window -t"

# A quick calculator using 'qalc' (requires qalculate)
bind C display-popup -w 50% -h 50% -E "qalc"


# Toggle the scratchpad popup window
bind "'" run-shell "~/.local/scripts/tmux-scratchpad.sh"

# A universal key to close any focused popup window
bind-key q detach-client -P

# "Promote" the scratchpad to a NEW WINDOW in the current session.
# This binding should be used AFTER closing the popup.
bind M-Enter new-window -d -t _scratchpad: \; move-window -s _scratchpad:

# "Join" the scratchpad as a NEW PANE in the current window (Vertical Split)
# This binding should be used AFTER closing the popup.
bind M-| new-window -d -t _scratchpad: \; join-pane -h -s _scratchpad:

# "Join" the scratchpad as a NEW PANE in the current window (Horizontal Split)
# This binding should be used AFTER closing the popup.
bind M-_ new-window -d -t _scratchpad: \; join-pane -v -s _scratchpad:


# --- NAVIGATION ---


bind-key W choose-window

# Shows the tmux sessions and you know. possible tmux seesions to open from ~/
# this is what I'm used to see
# this is meh I don't like it.
bind-key -r t run-shell "tmux neww ~/.local/scripts/tmux-sessionizer"

# the pop up is ass I like 
bind f display-popup -h 80% -E "~/.local/scripts/tmux-sessionizer"

# temporary terminal popup to run A quick run one command
# to be honest this is whatever could be salvagable
bind-key T run-shell "~/.local/scripts/tmux-temp-terminal.sh"

# Binds 'T' to prompt for a command, then runs that command in a popup.
bind-key p command-prompt -p "CLI prompt:" "display-popup -w 90% -h 90% '%%'"

# Find a file and open it in a new horizontal split
bind o display-popup -w 80% -h 80% -E "fd . -t f -H --ignore-file ~/scripts/excludes/fd/excludes_for_a_tmux_pop_up | fzf --reverse | xargs -I {} tmux split-window -h 'nvim {}'"

bind O display-popup -w 80% -h 80% -E " \
    yazi --chooser-file=/tmp/yazi-choice; \
    if [ -f /tmp/yazi-choice ]; then \
        tmux split-window -h \"nvim '$(cat /tmp/yazi-choice)'\"; \
        rm /tmp/yazi-choice; \
    fi \
"


# Toggle pane synchronization it's so sick if you have multiple panes and you want to type in all of them at once
bind M-v set-window-option synchronize-panes

# Open the session chooser menu
bind M-t choose-session



# it will kill the whole window with all it's panes unlike bind x where it only kills pane
bind X kill-window
bind -r C-M-h resize-pane -L 5
bind -r C-M-j resize-pane -D 5
bind -r C-M-k resize-pane -U 5
bind -r C-M-l resize-pane -R 5
bind z resize-pane -Z

#======
bind -r "<" swap-window -d -t -1
bind -r ">" swap-window -d -t +1

# Make pane swapping repeatable ('spamable')
bind-key -r '{' swap-pane -U
bind-key -r '}' swap-pane -D


# --- [4] WINDOW MANAGEMENT ---
bind c new-window -c "#{pane_current_path}"
bind , command-prompt "rename-window '%%'"


# --- [5] COPY MODE (THE VIM WAY) ---
bind [ copy-mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi q send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "~/.local/bin/Tmuxclip"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "~/.local/bin/Tmuxclip"

bind P paste-buffer


set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_with_mouse 'on'

run '~/.tmux/plugins/tpm/tpm'
